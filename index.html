<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Rifas ‚Äî Selecci√≥n de boletas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <meta name="theme-color" content="#0e7f30">

  <style>
:root{
  --bg:#129a3a;
  --bg-deep:#0e7f30;
  --ink:#ffffff;
  --muted:#e5ffe8;

  --accent1:#00ffa9;
  --accent2:#3db7ff;
  --accent3:#ffb24d;
  --danger:#ff3b30;

  --header-h:90px;
  --vv-top:0px;
  --extra-top:0px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%} html{overflow-anchor:none}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);
  background:var(--bg);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.2;
  padding-top:calc(var(--header-h) + var(--vv-top) + var(--extra-top));
  overscroll-behavior-y:contain;
  touch-action:manipulation;
}

/* ========= BOOT / LOADING ========= */
.boot{
  position:fixed; inset:0; z-index:10000;
  display:none; align-items:center; justify-content:center;
  padding:18px;
  background:
    radial-gradient(1200px 800px at 20% 20%, rgba(0,255,169,.18), transparent 55%),
    radial-gradient(1000px 800px at 80% 30%, rgba(61,183,255,.18), transparent 60%),
    radial-gradient(900px 700px at 55% 90%, rgba(255,178,77,.16), transparent 60%),
    linear-gradient(180deg, #0a2a16, #0b3a1d 35%, #0e7f30);
  overflow:hidden;
}
.boot.show{display:flex}
.boot::before{
  content:"";
  position:absolute; inset:-40%;
  background:conic-gradient(from 180deg, rgba(0,255,169,.22), rgba(61,183,255,.18), rgba(255,178,77,.18), rgba(0,255,169,.22));
  filter:blur(40px);
  animation:bootSpin 10s linear infinite;
  opacity:.85;
}
@keyframes bootSpin{to{transform:rotate(360deg)}}
.boot-bubbles{position:absolute; inset:0; pointer-events:none; opacity:.7;}
.boot-bubbles span{
  position:absolute;
  width:clamp(14px,3vw,24px); height:clamp(14px,3vw,24px);
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), rgba(255,255,255,.05));
  box-shadow:0 0 18px rgba(0,255,169,.25);
  animation:floatUp linear infinite;
  opacity:.6;
}
@keyframes floatUp{
  from{transform:translate3d(0, 110vh, 0) scale(.9); opacity:0}
  15%{opacity:.6}
  to{transform:translate3d(0, -20vh, 0) scale(1.15); opacity:0}
}
.boot-card{
  position:relative;
  width:min(92vw,560px);
  border-radius:22px;
  padding:18px 16px 16px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 24px 70px rgba(0,0,0,.55);
  -webkit-backdrop-filter: blur(10px) saturate(120%);
  backdrop-filter: blur(10px) saturate(120%);
  transform:translateZ(0);
}
.boot-top{display:flex; align-items:center; gap:12px;}
.boot-badge{
  width:54px; height:54px; border-radius:16px;
  display:grid; place-items:center;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 55%),
    linear-gradient(135deg, rgba(0,255,169,.85), rgba(61,183,255,.75), rgba(255,178,77,.7));
  box-shadow:0 0 0 1px rgba(255,255,255,.18), 0 14px 28px rgba(0,0,0,.35);
}
.boot-title{
  margin:0;
  font-weight:1000;
  letter-spacing:.3px;
  font-size:clamp(18px,4.8vw,22px);
  line-height:1.1;
}
.boot-sub{
  margin:4px 0 0;
  color:rgba(235,255,240,.9);
  font-weight:850;
  font-size:clamp(13px,3.6vw,14px);
  letter-spacing:.2px;
}
.boot-meter{
  margin-top:14px;
  height:12px;
  border-radius:999px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  overflow:hidden;
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);
}
.boot-meter > i{
  display:block; height:100%;
  width:35%;
  border-radius:999px;
  background:linear-gradient(90deg, rgba(0,255,169,.9), rgba(61,183,255,.9), rgba(255,178,77,.95));
  box-shadow:0 0 18px rgba(61,183,255,.25);
  animation:bootBar 1.25s ease-in-out infinite;
}
@keyframes bootBar{
  0%{transform:translateX(-40%)}
  50%{transform:translateX(110%)}
  100%{transform:translateX(240%)}
}
.boot-steps{margin-top:12px; display:flex; flex-wrap:wrap; gap:8px;}
.boot-chip{
  padding:8px 10px;
  border-radius:999px;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.14);
  color:rgba(235,255,240,.92);
  font-weight:850;
  font-size:12px;
}

/* ========= BLOQUEADO ========= */
.blocked{
  position:fixed; inset:0; z-index:9999;
  display:none; align-items:center; justify-content:center;
  padding:18px;
  background:
    radial-gradient(1200px 800px at 20% 20%, rgba(255,59,48,.20), transparent 55%),
    radial-gradient(1000px 800px at 80% 30%, rgba(61,183,255,.14), transparent 60%),
    linear-gradient(180deg, #081b10, #0b2a18 40%, #0e7f30);
}
.blocked.show{display:flex}
.blocked-card{
  width:min(92vw,680px);
  border-radius:24px;
  padding:20px 18px;
  background:rgba(0,0,0,.24);
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 24px 70px rgba(0,0,0,.60);
  -webkit-backdrop-filter: blur(12px) saturate(120%);
  backdrop-filter: blur(12px) saturate(120%);
  text-align:center;
}
.blocked-title{margin:10px 0 6px; font-weight:1000; font-size:clamp(18px,5.2vw,24px);}
.blocked-text{
  margin:0 auto 12px; max-width:54ch;
  color:rgba(235,255,240,.92);
  font-weight:850;
  font-size:clamp(13px,3.8vw,14px);
  line-height:1.38;
  white-space:pre-line;
}
.blocked-hint{
  margin:0 auto 14px; max-width:62ch;
  color:rgba(235,255,240,.88);
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  padding:12px 12px;
  font-weight:800;
  font-size:12px;
  text-align:left;
  white-space:pre-line;
}
.blocked-actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
.blocked-btn{
  border:none; cursor:pointer;
  border-radius:14px; padding:12px 16px;
  font-weight:950; letter-spacing:.3px;
  color:#062017;
  background:linear-gradient(90deg,var(--accent1),#a9ffdf);
  box-shadow:0 0 0 1px rgba(255,255,255,.22),0 12px 28px rgba(0,0,0,.45);
}
.blocked-btn.alt{
  color:#fff;
  background:linear-gradient(90deg,var(--danger),#ffb3ad);
}
.blocked-badge{
  width:74px; height:74px; border-radius:22px;
  margin:0 auto;
  display:grid; place-items:center;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%),
    linear-gradient(135deg, rgba(255,59,48,.85), rgba(255,178,77,.7), rgba(61,183,255,.55));
  box-shadow:0 0 0 1px rgba(255,255,255,.18), 0 18px 38px rgba(0,0,0,.45);
}

/* ========= HEADER / UI ========= */
.top-veil{
  position:fixed; left:0; right:0; top:0; z-index:25; pointer-events:none;
  height:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 16px);
  background:linear-gradient(180deg,rgba(14,127,48,.94) 0%,rgba(14,127,48,.88) 40%,rgba(14,127,48,.72) 70%,rgba(14,127,48,0) 100%);
  -webkit-backdrop-filter:saturate(120%) blur(6px);
  backdrop-filter:saturate(120%) blur(6px);
  border-bottom:1px solid rgba(255,255,255,.12);
}
header{
  position:fixed; left:0; right:0; z-index:30; top:0 !important;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  padding:10px 14px; min-height:90px;
  background:linear-gradient(0deg,rgba(0,0,0,.18),rgba(0,0,0,.18)), var(--bg-deep);
  border-bottom:1px solid rgba(255,255,255,.12);
  box-shadow:0 10px 26px rgba(0,0,0,.35);
  transform:translateZ(0);
  backface-visibility:hidden;
  contain:paint;
}
.brand{display:flex;align-items:center;gap:12px}
.brand img{
  height:56px;width:56px;object-fit:cover;border-radius:50%;
  border:2px solid rgba(255,255,255,.2);
  box-shadow:0 0 0 2px rgba(255,255,255,.18),0 0 22px rgba(0,0,0,.25)
}
.brand h1{
  margin:0;
  font-weight:900;
  font-size:clamp(18px,3.2vw,24px);
  letter-spacing:.5px;
  background:linear-gradient(90deg,#fff,var(--accent2) 50%,var(--accent1) 90%);
  -webkit-background-clip:text;background-clip:text;color:transparent
}
.search-bar{
  flex:1 1 320px;
  height:56px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.22);
  padding:0 14px;
  font-size:20px;
  line-height:56px;
  outline:none;
  background:#0f3c1e;
  color:#f6fff7;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25);
  touch-action:manipulation;
  caret-color:#ffffff;
  -webkit-appearance:none;
  appearance:none;
}
.search-bar::placeholder{color:rgba(235,255,240,.8)}
.search-bar:focus{box-shadow:inset 0 0 0 2px var(--accent2),0 0 16px rgba(61,183,255,.45)}

.random-button{
  height:56px;
  border-radius:16px;
  padding:0 16px;
  font-weight:900;
  letter-spacing:.5px;
  border:none;
  cursor:pointer;
  color:#062017;
  background:linear-gradient(90deg,var(--accent1),#a9ffdf)
}

.contact-info{display:flex;flex-direction:row;align-items:center;gap:10px;margin-left:auto}
.contact-info p{margin:0;font-size:12px;color:#e5ffe8;font-weight:800;letter-spacing:.2px}

.finish-top-button{
  height:40px; min-height:40px;
  border-radius:999px;
  padding:0 18px;
  font-size:12px;
  font-weight:900;
  letter-spacing:.5px;
  text-transform:uppercase;
  border:none;
  cursor:pointer;
  color:#062017;
  background:linear-gradient(90deg,var(--accent3),var(--accent1));
  box-shadow:0 0 0 1px rgba(255,255,255,.25),0 8px 20px rgba(0,0,0,.45);
  display:none;
  flex-shrink:0;
  align-items:center;
  justify-content:center;
  line-height:1;
}

.search-result{
  position:fixed;
  top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 12px);
  left:50%;
  transform:translateX(-50%);
  z-index:55;
  display:none;
  width:min(92vw,720px);
  pointer-events:auto;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:12px
}
body.search-has-text #raffles{ display:none !important; }

#raffles{
  display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
  margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh
}

/* carrito */
.cart-panel{
  display:none;
  flex:0 0 100%;
  margin-top:6px;
  padding:6px 10px 4px;
  border-radius:14px;
  background:rgba(0,0,0,.2);
  border:1px solid rgba(255,255,255,.2);
  box-shadow:0 10px 26px rgba(0,0,0,.45);
  display:flex;
  align-items:flex-start;
  gap:8px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.cart-label{
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.5px;
  padding-top:4px;
  color:var(--muted);
  white-space:nowrap;
}
.cart-strip{
  display:flex;
  gap:8px;
  flex:1;
  overflow-x:auto;
  padding:3px 0 4px;
  scroll-snap-type:x mandatory;
}
.cart-item{
  flex:0 0 auto;
  min-width:60px;
  padding:6px 9px;
  border-radius:999px;
  background:
    radial-gradient(circle at 0% 0%, rgba(255,255,255,.32) 0, transparent 40%),
    linear-gradient(120deg,var(--accent1),var(--accent2),var(--accent3));
  box-shadow:0 0 0 1px rgba(255,255,255,.35),0 0 16px rgba(0,0,0,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  position:relative;
  scroll-snap-align:start;
  animation:cartPulse 1.5s infinite alternate;
}
.cart-item::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:inherit;
  border:1px solid rgba(255,255,255,.22);
  box-shadow:0 0 18px rgba(0,255,169,.8);
  opacity:.45;
  pointer-events:none;
}
.cart-item-num{
  font-size:18px;
  font-weight:900;
  text-shadow:0 0 10px rgba(0,0,0,.7);
}
.cart-item-remove{
  border:none;
  outline:none;
  cursor:pointer;
  width:20px;
  height:20px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:900;
  background:rgba(0,0,0,.6);
  color:#ffffff;
  box-shadow:0 0 0 1px rgba(255,255,255,.35),0 0 10px rgba(0,0,0,.8);
  padding:0;
}
@keyframes cartPulse{
  0%{ box-shadow:0 0 0 1px rgba(255,255,255,.3),0 0 10px rgba(0,255,169,.55); transform:translateY(0) scale(1); }
  50%{ box-shadow:0 0 0 1px rgba(255,255,255,.4),0 0 18px rgba(61,183,255,.85); transform:translateY(-1px) scale(1.03); }
  100%{ box-shadow:0 0 0 1px rgba(255,255,255,.28),0 0 22px rgba(255,178,77,.95); transform:translateY(0) scale(1); }
}

/* tiles */
.raffle{
  --size:clamp(92px,26vw,124px);
  width:var(--size);
  height:calc(var(--size) + 16px);
  border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  position:relative;
  font-weight:900;
  color:#fff;
  background:
    radial-gradient(circle at 50% 28%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 37% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 63% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    linear-gradient(145deg, transparent 0 62%, rgba(255,255,255,.10) 63%, transparent 64%),
    linear-gradient(160deg,#0b2b15,#0a2412 60%);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);
  outline:none;
  cursor:pointer;
  border:none;
  transform:translateZ(0)
}
.raffle span{
  font-size:clamp(38px,8.5vw,48px);
  line-height:1;
  text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18)
}
.raffle::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:inherit;
  padding:6px;
  background:conic-gradient(from 180deg at 50% 50%,var(--accent1),var(--accent2),var(--accent3),var(--accent1));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  opacity:.95
}
.raffle::after{
  content:"";
  position:absolute;
  inset:2px;
  border-radius:14px;
  background:radial-gradient(60% 60% at 50% 45%, rgba(255,255,255,.08), transparent 70%);
  z-index:0
}
.large-raffle{
  --size:clamp(160px,52vw,200px);
  width:var(--size);
  height:calc(var(--size) + 18px)
}
.large-raffle span{font-size:clamp(50px,12vw,70px)}
.raffle.revealed span{animation:revealPop .6s cubic-bezier(.2,.9,.2,1)}
@keyframes revealPop{
  0%{transform:scale(.9);filter:brightness(1.25);text-shadow:0 0 18px rgba(255,255,255,.55),0 0 30px rgba(0,255,169,.28)}
  55%{transform:scale(1.05)}
  100%{transform:scale(1);filter:none}
}

/* toast */
.message{
  padding:14px 16px;
  background:rgba(255,255,255,.12);
  color:#fff;
  border:1px solid rgba(255,255,255,.45);
  border-radius:14px;
  width:min(92vw,420px);
  text-align:center;
  font-size:clamp(16px,4.8vw,22px);
  font-weight:900;
  display:none;
  position:fixed;
  top:calc(var(--vv-top) + var(--extra-top) + var(--header-h) + 10px);
  left:50%;
  transform:translateX(-50%);
  z-index:60;
  box-shadow:0 12px 30px rgba(0,0,0,.35)
}
.message.error{background:var(--danger);border-color:#ffd0d0;color:#fff}

/* modal */
.ov{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter:saturate(120%) blur(2px);
  z-index:9000;
  display:none;
  align-items:center;
  justify-content:center
}
.ov.show{display:flex}
.box{
  display:block;
  min-width:min(92vw,520px);
  max-width:92vw;
  background:#0f3c1e;
  color:#fff;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  padding:20px 18px;
  text-align:center;
  transform-origin:center center
}
.q{margin:0 0 10px 0;font-size:clamp(18px,5vw,22px);font-weight:900}
.actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:6px;}
.btn.ok{font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;background:linear-gradient(90deg,var(--accent1),#a9ffdf);color:#062017}
.btn.no{font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606}

@media(max-width:768px){
  header{gap:8px;padding:12px 10px}
  .contact-info{flex-direction:row;flex-wrap:wrap;justify-content:center}
  .search-bar,.random-button{width:100%}
  #raffles{gap:10px;margin-top:12px}
}

@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation:none !important;transition:none !important}
  .boot::before{animation:none !important}
}
  </style>
</head>

<body>
  <!-- LOADING -->
  <div id="boot" class="boot show" aria-hidden="false">
    <div class="boot-bubbles" aria-hidden="true" id="bootBubbles"></div>
    <div class="boot-card" role="status" aria-live="polite">
      <div class="boot-top">
        <div class="boot-badge" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l7 4v6c0 5-3 9-7 10-4-1-7-5-7-10V6l7-4z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
            <path d="M8.5 12.2l2.2 2.3 4.8-5.1" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <p class="boot-title" id="bootTitle">Cargando‚Ä¶</p>
          <p class="boot-sub" id="bootSub">Verificando acceso</p>
        </div>
      </div>
      <div class="boot-meter" aria-hidden="true"><i></i></div>
      <div class="boot-steps" id="bootSteps">
        <div class="boot-chip"><strong>1</strong> Acceso</div>
        <div class="boot-chip"><strong>2</strong> Config</div>
        <div class="boot-chip"><strong>3</strong> Boletas</div>
      </div>
    </div>
  </div>

  <!-- BLOQUEADO -->
  <div id="blocked" class="blocked" aria-hidden="true">
    <div class="blocked-card">
      <div class="blocked-badge" aria-hidden="true">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
          <path d="M12 2l8 4v6c0 6-3.6 10.1-8 12-4.4-1.9-8-6-8-12V6l8-4z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9 12h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 9v6" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <h2 class="blocked-title" id="blockedTitle">P√°gina temporalmente inhabilitada</h2>
      <p class="blocked-text" id="blockedText"></p>
      <div class="blocked-hint" id="blockedHint" style="display:none"></div>
      <div class="blocked-actions">
        <button class="blocked-btn" id="blockedReload" type="button">Reintentar</button>
        <button class="blocked-btn alt" id="blockedWhats" type="button">Contactar</button>
      </div>
    </div>
  </div>

  <div class="top-veil" aria-hidden="true"></div>

  <header>
    <div class="brand">
      <img id="logoImg" src="" alt="Logo" referrerpolicy="no-referrer">
      <h1 id="houseName">Rifas</h1>
    </div>

    <input id="search" class="search-bar" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4"
           enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
           placeholder="Buscar # de boleta‚Ä¶">

    <button class="random-button" id="randomButton" type="button"># ALEATORIO</button>

    <div class="contact-info">
      <p id="phone"></p>
      <p id="address"></p>
    </div>

    <button id="finishTop" class="finish-top-button" type="button">Finalizar</button>
    <div id="cartPanel" class="cart-panel" aria-live="polite"></div>
  </header>

  <div id="searchResult" class="search-result"></div>
  <div id="raffles" aria-live="polite"></div>

  <div id="ov" class="ov" aria-hidden="true">
    <div id="box" class="box" role="dialog" aria-modal="true">
      <p id="q" class="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok" type="button">S√≠</button>
        <button id="keep" class="btn ok" type="button">Seguir separando</button>
        <button id="no" class="btn no" type="button">No</button>
      </div>
    </div>
  </div>

  <div id="message" class="message">Boleta ocupada</div>

  <script>
/* =========================================================
   ‚úÖ EDITABLE AL INICIO
   ========================================================= */
const KEY               = '1MyOkJrGpeY1ZXQVFq_srndALEh6Nzzir8sFSfu-0EVM';
const GID_RAFFLES       = '1661037065';   // A: N√∫mero, B: Libre/Asignado
const GID_CONFIGURACION = '1977832725';   // Configuracion: X2 (bloqueo) + K2 (celular)
const GID_NOTIFICACIONES= '662101636';    // Notificaciones: D2 (logo)

// ‚úÖ Proxies en orden (primero tu Worker)
const PROXIES = [
  'https://csv-proxy.jeisendigital.workers.dev/?u=',
  // backups (por si tu worker est√° ca√≠do temporalmente)
  'https://corsproxy.io/?url=',
  'https://api.allorigins.win/raw?url='
];

// Celdas fijas:
const ENABLE_CELL = { row: 2, col: 'X' }; // Configuracion!X2 -> "TRUE"/"FALSE"
const PHONE_CELL  = { row: 2, col: 'K' }; // Configuracion!K2 -> celular
const LOGO_CELL   = { row: 2, col: 'D' }; // Notificaciones!D2 -> logo (URL)

/* =========================
   Cach√©s
   ========================= */
const CACHE_TTL_MS = 10 * 60 * 1000; // 10 min
const MAP_CACHE_KEY      = 'raffle_map_v4';
const CONF_CACHE_KEY     = 'raffle_conf_v3';
const ENABLE_CACHE_KEY   = 'raffle_enabled_v3';
const LOGO_CACHE_KEY     = 'raffle_logo_v2';

function saveMapCache(freeList){
  try{ localStorage.setItem(MAP_CACHE_KEY, JSON.stringify({ts:Date.now(), freeList})) }catch(_){}
}
function loadMapCache(){
  try{
    const raw = localStorage.getItem(MAP_CACHE_KEY);
    if(!raw) return null;
    const {ts, freeList} = JSON.parse(raw);
    if(!Array.isArray(freeList)) return null;
    if(Date.now() - ts > CACHE_TTL_MS) return {freeList, stale:true};
    return {freeList, stale:false};
  }catch(_){ return null; }
}
function saveConfCache(conf){
  try{ localStorage.setItem(CONF_CACHE_KEY, JSON.stringify({ts:Date.now(), conf})) }catch(_){}
}
function loadConfCache(){
  try{
    const raw = localStorage.getItem(CONF_CACHE_KEY);
    if(!raw) return null;
    const {ts, conf} = JSON.parse(raw);
    if(!conf) return null;
    return {conf, stale:(Date.now()-ts) > CACHE_TTL_MS};
  }catch(_){ return null; }
}
function saveEnabledCache(val){
  try{ localStorage.setItem(ENABLE_CACHE_KEY, JSON.stringify({ts:Date.now(), val: !!val})) }catch(_){}
}
function loadEnabledCache(){
  try{
    const raw = localStorage.getItem(ENABLE_CACHE_KEY);
    if(!raw) return null;
    const {ts, val} = JSON.parse(raw);
    if(typeof val !== 'boolean') return null;
    return {val, stale:(Date.now()-ts) > CACHE_TTL_MS};
  }catch(_){ return null; }
}
function saveLogoCache(url){
  try{ localStorage.setItem(LOGO_CACHE_KEY, JSON.stringify({ts:Date.now(), url: String(url||'')})) }catch(_){}
}
function loadLogoCache(){
  try{
    const raw = localStorage.getItem(LOGO_CACHE_KEY);
    if(!raw) return null;
    const {ts, url} = JSON.parse(raw);
    if(!url) return null;
    return {url, stale:(Date.now()-ts) > CACHE_TTL_MS};
  }catch(_){ return null; }
}

/* =========================
   BOOT UI
   ========================= */
function bootShow(title, sub){
  const boot = document.getElementById('boot');
  if(!boot) return;
  if(title) document.getElementById('bootTitle').textContent = title;
  if(sub)   document.getElementById('bootSub').textContent   = sub;
  boot.classList.add('show');
  boot.setAttribute('aria-hidden','false');
}
function bootHide(){
  const boot = document.getElementById('boot');
  if(!boot) return;
  boot.classList.remove('show');
  boot.setAttribute('aria-hidden','true');
}
function blockedShow({title, text, hint}){
  const layer = document.getElementById('blocked');
  if(!layer) return;

  document.getElementById('blockedTitle').textContent = title || 'P√°gina temporalmente inhabilitada';
  document.getElementById('blockedText').textContent  = text  || 'Acceso restringido.';

  const hintEl = document.getElementById('blockedHint');
  if(hint){
    hintEl.style.display = 'block';
    hintEl.textContent = hint;
  }else{
    hintEl.style.display = 'none';
    hintEl.textContent = '';
  }

  layer.classList.add('show');
  layer.setAttribute('aria-hidden','false');
  bootHide();
}
function initBootBubbles(){
  const wrap = document.getElementById('bootBubbles');
  if(!wrap) return;
  wrap.innerHTML = '';
  const reduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
  if(reduced) return;
  const N = 18;
  for(let i=0;i<N;i++){
    const s = document.createElement('span');
    const left = Math.random()*100;
    const delay = -Math.random()*8;
    const dur = 7 + Math.random()*6;
    const scale = 0.8 + Math.random()*1.4;
    s.style.left = left.toFixed(2)+'%';
    s.style.animationDuration = dur.toFixed(2)+'s';
    s.style.animationDelay = delay.toFixed(2)+'s';
    s.style.transform = `scale(${scale.toFixed(2)})`;
    s.style.opacity = (0.35 + Math.random()*0.4).toFixed(2);
    wrap.appendChild(s);
  }
}

/* =========================
   Fetch robusto (detecta JSON de error del Worker)
   ========================= */
function isProbablyHtml(txt){
  const t = String(txt || '').trimStart();
  return t.startsWith('<!DOCTYPE') || t.startsWith('<html') || t.startsWith('<');
}
async function fetchTextWithTimeout(url, timeout=7500){
  const ctrl = new AbortController();
  const to = setTimeout(()=>ctrl.abort(), timeout);

  try{
    const r = await fetch(url, {
      signal: ctrl.signal,
      cache: 'no-store',
      credentials: 'omit',
      redirect: 'follow'
    });

    const ct = (r.headers.get('content-type') || '').toLowerCase();
    const text = await r.text();

    // Si NO ok: intenta extraer reason del JSON del worker
    if(!r.ok){
      let more = '';
      try{
        const j = JSON.parse(text);
        if(j && typeof j === 'object'){
          more = `reason=${j.reason || 'unknown'}` +
                 (j.upstream_status ? ` upstream_status=${j.upstream_status}` : '') +
                 (j.hint ? ` hint=${j.hint}` : '');
        }
      }catch(_){}
      const msg = `HTTP ${r.status}` + (more ? ` (${more})` : '');
      const err = new Error(msg);
      err.status = r.status;
      err.contentType = ct;
      err.body = text;
      throw err;
    }

    // OK pero vino HTML o vac√≠o -> error
    if(!text || isProbablyHtml(text)){
      const err = new Error('Respuesta inv√°lida (HTML/empty)');
      err.status = 200;
      err.contentType = ct;
      err.body = text;
      throw err;
    }

    return text;
  } finally {
    clearTimeout(to);
  }
}

function csvUrls(gid){
  const ts = Date.now();
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&gid=${gid}&_=${ts}`,
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&gid=${gid}&_=${ts}`
  ];
}

async function fetchCsvAny(gid, timeoutEach=7500){
  const bases = csvUrls(gid);
  let lastErr = null;

  for(const base of bases){
    for(const p of PROXIES){
      const finalUrl = p + encodeURIComponent(base);
      try{
        return await fetchTextWithTimeout(finalUrl, timeoutEach);
      }catch(e){
        lastErr = e;
      }
    }
  }

  throw (lastErr || new Error('No se pudo obtener CSV'));
}

/* =========================
   CSV parser (simple + robusto)
   ========================= */
function parseCSV(text){
  if (String(text).trimStart().startsWith('<')) return [];
  const rows=[]; let i=0,cur='',inQ=false;
  const push=()=>{ rows[rows.length-1].push(cur); cur='' };
  rows.push([]);
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"'){
        if(text[i+1]==='"'){cur+='"';i++} else inQ=false
      } else cur+=c;
    }else{
      if(c==='"') inQ=true;
      else if(c===',') push();
      else if(c==='\n'){ push(); rows.push([]); }
      else if(c!=='\r') cur+=c;
    }
    i++;
  }
  push();
  return rows.filter(r => r.some(x=>String(x).trim()!=='')); 
}

/* =========================
   Helpers: letras de columna
   ========================= */
function colLetterToIndex(letter){
  const L = String(letter||'').trim().toUpperCase();
  if(!L) return 0;
  let n=0;
  for(let i=0;i<L.length;i++){
    const code = L.charCodeAt(i);
    if(code<65 || code>90) continue;
    n = n*26 + (code-64);
  }
  return Math.max(1,n) - 1;
}
function getCell(rows, rowNumber1Based, colLetter){
  const rIdx = Math.max(1, rowNumber1Based) - 1;
  const cIdx = colLetterToIndex(colLetter);
  return rows?.[rIdx]?.[cIdx];
}

/* =========================
   Normalizaci√≥n celular Colombia
   ========================= */
function extractColombiaDigits(raw){
  const chunks=(String(raw||'').match(/\d+/g)||[]);
  let d=chunks.join('').replace(/^00/,'');
  const m=d.match(/57(3\d{9})/); if(m) return '57'+m[1];
  const m2=d.match(/(?:^|[^0-9])(3\d{9})(?:[^0-9]|$)/); if(m2) return '57'+m2[1];
  const m3=d.match(/0(3\d{9})/); if(m3) return '57'+m3[1];
  if(d.startsWith('57') && d.length>=12) return d.slice(0,12);
  return null;
}

/* =========================
   Apply UI config
   ========================= */
function applyConfigPartial({name, phoneRaw, address}){
  if(name) document.getElementById('houseName').textContent = String(name||'').trim();
  if(phoneRaw !== undefined){
    document.getElementById('phone').textContent = phoneRaw ? ('Tel: ' + phoneRaw) : '';
    window.__CONFIG_PHONE = phoneRaw || '';
    window.__CONFIG_PHONE_DIGITS = extractColombiaDigits(phoneRaw) || '';
  }
  if(address !== undefined){
    document.getElementById('address').textContent = address ? ('Dir: ' + address) : '';
  }
}
function applyLogo(url){
  const img = document.getElementById('logoImg');
  if(img) img.src = String(url||'').trim();
}

/* =========================
   Lecturas desde Sheets
   ========================= */
function readBlockedFromConfig(rows){
  const raw = String(getCell(rows, ENABLE_CELL.row, ENABLE_CELL.col) ?? '').trim().toUpperCase();
  return (raw === 'TRUE');
}
function readConfFromConfig(rows){
  // Nombre/Dir son opcionales por headers (si existen).
  const head=rows[0]||[], data=rows[1]||[];
  const hIdx=(name)=> head.findIndex(h => String(h).trim().toLowerCase()===String(name).toLowerCase());
  const name = data[hIdx('Nombre_APP')] || data[hIdx('Nombre_De_La_Rifa')] || 'Rifas';
  const address = data[hIdx('Direccion')] || '';
  // Celular FIJO K2
  const phoneK2 = String(getCell(rows, PHONE_CELL.row, PHONE_CELL.col) ?? '').trim();
  return { name, address, phoneRaw: phoneK2 || '' };
}
function readLogoFromNotif(rows){
  return String(getCell(rows, LOGO_CELL.row, LOGO_CELL.col) ?? '').trim();
}

/* =========================
   Fail-closed access check
   ========================= */
async function loadConfigAndCheckAccess(){
  // cache visual
  const cachedConf = loadConfCache();
  if(cachedConf?.conf) applyConfigPartial(cachedConf.conf);

  const cachedLogo = loadLogoCache();
  if(cachedLogo?.url) applyLogo(cachedLogo.url);

  // ‚úÖ SIEMPRE intentar leer Configuracion; si falla -> bloquea (fail-closed)
  try{
    const txt  = await fetchCsvAny(GID_CONFIGURACION, 8500);
    const rows = parseCSV(txt);

    if(rows.length >= 2){
      const blocked = readBlockedFromConfig(rows);
      saveEnabledCache(blocked);

      const conf = readConfFromConfig(rows);
      applyConfigPartial(conf);
      saveConfCache(conf);

      return { blocked, ok:true, reason:'', details:'' };
    }

    return { blocked:true, ok:false, reason:'CSV vac√≠o o incompleto', details:'No llegaron filas suficientes (m√≠nimo 2).' };

  }catch(e){
    // fail-closed con info √∫til
    let details = '';
    if(e && e.body){
      // si el worker devuelve JSON, ya viene reason/hint embebido en el mensaje; igual mostramos pedacito controlado
      const snippet = String(e.body).slice(0, 600);
      details = snippet;
    }
    return {
      blocked:true,
      ok:false,
      reason: (e && e.message) ? e.message : 'Error de red/proxy',
      details
    };
  }
}

/* =========================
   Logo (no bloqueante)
   ========================= */
async function loadLogoFromNotificaciones(){
  // cache visual
  const cached = loadLogoCache();
  if(cached?.url) applyLogo(cached.url);

  try{
    const txt  = await fetchCsvAny(GID_NOTIFICACIONES, 8500);
    const rows = parseCSV(txt);
    if(rows.length >= 2){
      const logo = readLogoFromNotif(rows);
      if(logo){
        applyLogo(logo);
        saveLogoCache(logo);
      }
    }
  }catch(_){}
}

/* =========================
   App state
   ========================= */
let ALL = {};
let DAILY = [];
let SEARCH_INPUT = null;
let GRID_TIMER = null;
let MAP_TIMER = null;
let MODAL_OPEN = false;
let DAY_MARK = null;

let CART_ACTIVE = false;
let CART_ITEMS = [];

/* =========================
   Utils
   ========================= */
const pad4 = n => String(n).replace(/\D/g,'').slice(0,4).padStart(4,'0');
const todayKey = () => new Date().toISOString().slice(0,10);
function randInt(maxExclusive){
  if (crypto?.getRandomValues){ const b = new Uint32Array(1); crypto.getRandomValues(b); return b[0] % maxExclusive; }
  return Math.floor(Math.random()*maxExclusive);
}
function msg(text, error=false){
  const el = document.getElementById('message'); if(!el) return;
  el.textContent = text || '';
  el.classList.toggle('error', !!error);
  el.style.display = 'block';
  clearTimeout(msg._t);
  msg._t = setTimeout(()=>{ el.style.display = 'none'; }, error ? 2000 : 1000);
}
function hideMsg(){ const el = document.getElementById('message'); if(!el) return; clearTimeout(msg._t); el.style.display='none'; }

function makeBaseMap(){
  const map={};
  for(let i=0;i<10000;i++) map[String(i).padStart(4,'0')] = 'ocupado';
  return map;
}
function normStatusAB(s){
  const t=String(s??'').trim().toLowerCase();
  return t==='libre' ? 'libre' : 'ocupado';
}

function recalcHeaderHeightDynamic(){
  const hEl = document.querySelector('header');
  if(!hEl) return;
  const h = Math.max(70, Math.round(hEl.getBoundingClientRect().height));
  document.documentElement.style.setProperty('--header-h', h + 'px');
}

/* =========================
   WhatsApp (usa Configuracion K2)
   ========================= */
function openWA(payload){
  const tel = window.__CONFIG_PHONE_DIGITS || ''; // si no hay, igual abre sin (lo evitamos abajo)
  if(!tel){
    msg('No hay celular v√°lido en Configuracion (K2).', true);
    return;
  }

  let message = '';
  if (Array.isArray(payload)) {
    const unique = Array.from(new Set(payload.map(pad4)));
    if (!unique.length) return;
    const listado = unique.map((n,idx)=> `${idx+1}. ${n}`).join('\n');
    message =
      `Hola üëã\n\n` +
      `Estoy interesado en separar los siguientes n√∫meros:\n\n` +
      `${listado}\n\n` +
      `Total: ${unique.length} n√∫mero${unique.length>1?'s':''}.\n\n` +
      `¬øMe confirmas disponibilidad, por favor?`;
  } else {
    const number = pad4(payload);
    message = `Hola üëã\n\nEstoy interesado en separar esta boleta: ${number}\n\n¬øEst√° disponible?`;
  }

  const url = "https://wa.me/" + tel + "?text=" + encodeURIComponent(message);
  const w = window.open(url, '_blank', 'noopener');
  if (!w) location.href = url;
}
function openWAContact(){
  const tel = window.__CONFIG_PHONE_DIGITS || '';
  if(!tel){
    msg('No hay celular v√°lido en Configuracion (K2).', true);
    return;
  }
  const msgText = "Hola üëã\n\nLa p√°gina de boletas aparece inhabilitada / sin verificaci√≥n.\n¬øMe ayudas a revisarla, por favor?";
  const url = "https://wa.me/" + tel + "?text=" + encodeURIComponent(msgText);
  const w = window.open(url, '_blank', 'noopener');
  if (!w) location.href = url;
}

/* =========================
   Carrito
   ========================= */
function updateTopFinishVisibility(){
  const btn = document.getElementById('finishTop');
  if(!btn) return;
  btn.style.display = (CART_ACTIVE && CART_ITEMS.length) ? 'inline-flex' : 'none';
}
function renderCart(){
  const panel = document.getElementById('cartPanel');
  if(!panel) return;
  panel.innerHTML = '';

  if(!CART_ITEMS.length){
    panel.style.display = 'none';
    recalcHeaderHeightDynamic();
    return;
  }

  panel.style.display = 'flex';

  const label = document.createElement('div');
  label.className = 'cart-label';
  label.textContent = 'Carrito (' + CART_ITEMS.length + ')';
  panel.appendChild(label);

  const strip = document.createElement('div');
  strip.className = 'cart-strip';
  panel.appendChild(strip);

  CART_ITEMS.forEach(num=>{
    const item = document.createElement('div');
    item.className = 'cart-item';
    item.dataset.num = num;
    item.innerHTML =
      `<span class="cart-item-num">${num}</span>`+
      `<button type="button" class="cart-item-remove" aria-label="Quitar ${num}">&times;</button>`;
    strip.appendChild(item);
  });

  strip.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.cart-item-remove');
    if(!btn) return;
    const parent = btn.closest('.cart-item');
    const num = parent?.dataset.num;
    if(!num) return;
    removeFromCart(num);
  });

  recalcHeaderHeightDynamic();
}
function addToCart(n){
  const num = pad4(n);
  if (!CART_ITEMS.includes(num)) CART_ITEMS.push(num);
  if(!CART_ACTIVE){
    CART_ACTIVE = true;
    document.body.classList.add('cart-active');
  }
  renderCart();
  updateTopFinishVisibility();
}
function removeFromCart(num){
  const idx = CART_ITEMS.indexOf(num);
  if(idx>-1) CART_ITEMS.splice(idx,1);
  if(!CART_ITEMS.length){
    CART_ACTIVE = false;
    document.body.classList.remove('cart-active');
  }
  renderCart();
  updateTopFinishVisibility();
}
function finalizeCart(){
  if(!CART_ACTIVE || !CART_ITEMS.length){
    msg('No hay n√∫meros en el carrito', true);
    return;
  }
  const unique = Array.from(new Set(CART_ITEMS.map(pad4)));
  openWA(unique);
  CART_ITEMS = [];
  CART_ACTIVE = false;
  document.body.classList.remove('cart-active');
  renderCart();
  updateTopFinishVisibility();
}

/* =========================
   Grid / tiles
   ========================= */
function makeTile(num, large){
  const el = document.createElement('div');
  el.className = 'raffle' + (large ? ' large-raffle' : '');
  el.innerHTML = `<span>${num}</span>`;
  el.addEventListener('pointerdown', (ev)=>{ el._lastPt = {x:ev.clientX, y:ev.clientY}; }, {passive:true});
  el.addEventListener('touchstart', (ev)=>{ const t=ev.touches&&ev.touches[0]; if(t) el._lastPt={x:t.clientX,y:t.clientY}; }, {passive:true});
  el.addEventListener('click', (ev)=> onTileTap(el, num), {passive:true});
  return el;
}
function renderGrid(){
  const wrap=document.getElementById('raffles'); if(!wrap) return;
  if(document.body.classList.contains('search-has-text') || MODAL_OPEN) return;
  wrap.innerHTML='';
  const frag = document.createDocumentFragment();
  for(const n of DAILY){ frag.appendChild(makeTile(n,false)); }
  wrap.appendChild(frag);
}
function renderSearchOne(num){
  const layer=document.getElementById('searchResult');
  layer.style.display='none'; layer.innerHTML=''; if(!num) return;
  const t=makeTile(num,true); layer.appendChild(t); layer.style.display='flex';
  requestAnimationFrame(()=> t.classList.add('revealed'));
}
function clearSearchLayer(){
  const layer=document.getElementById('searchResult');
  layer.style.display='none'; layer.innerHTML='';
}

/* =========================
   Modal
   ========================= */
function closeBox(withScale){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  if(!ov||!box) return;
  const a1 = box.animate(withScale?[{transform:'scale(1)',opacity:1},{transform:'scale(.94)',opacity:0}]:[{opacity:1},{opacity:0}],{duration:180,easing:'ease-in',fill:'forwards'});
  const a2 = ov.animate([{backgroundColor:'rgba(0,0,0,0.35)'},{backgroundColor:'rgba(0,0,0,0)'}],{duration:180,fill:'forwards'});
  Promise.all([a1.finished,a2.finished]).catch(()=>{}).finally(()=>{
    MODAL_OPEN=false; ov.classList.remove('show'); ov.setAttribute('aria-hidden','true');
    box.style.opacity='1'; box.style.transform='none'; ov.style.backgroundColor='rgba(0,0,0,.35)';
  });
}

function showChoiceFromTile(tile, n){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  const yes=document.getElementById('yes'), no=document.getElementById('no'), q=document.getElementById('q');
  const keep=document.getElementById('keep');
  if(!ov||!box||!yes||!no||!q||!keep) return;

  MODAL_OPEN=true;

  if(!CART_ACTIVE){
    q.textContent = "¬øQuieres separar este n√∫mero? " + n;
    yes.style.display = 'inline-block';
    no.style.display = 'inline-block';
    keep.style.display = 'inline-block';
    yes.textContent = 'S√≠';
    no.textContent = 'No';
    keep.textContent = 'Seguir separando';
  }else{
    q.textContent = "Has seleccionado el n√∫mero " + n;
    keep.style.display = 'inline-block';
    yes.style.display = 'inline-block';
    no.style.display = 'none';
    keep.textContent = 'Seguir separando';
    yes.textContent = 'Finalizar';
  }

  ov.classList.add('show'); ov.setAttribute('aria-hidden','false');

  yes.onclick = (e)=>{
    e.preventDefault(); e.stopPropagation();
    if(CART_ACTIVE){
      addToCart(n);
      closeBox(true);
      finalizeCart();
    }else{
      closeBox(true);
      openWA(n);
    }
  };
  no.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(false); };
  keep.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); addToCart(n); closeBox(true); };

  ov.onclick = ()=> closeBox(false);
  box.onclick=(e)=> e.stopPropagation();
}

function onTileTap(el, num){
  if(!el || el.dataset.busy==='1') return;
  el.dataset.busy='1';
  hideMsg();
  setTimeout(()=>{ showChoiceFromTile(el, num); el.dataset.busy=''; }, 120);
}

/* =========================
   Mapa boletas
   ========================= */
function setAllFromFreeList(freeList){
  const map = makeBaseMap();
  for(const n of freeList){ map[n] = 'libre'; }
  ALL = map;
}
function sampleDailyFromFreeList(freeList, target=240){
  const L = freeList.length;
  if(L<=target) return [...freeList];
  const out = freeList.slice(0, target);
  for(let i=target;i<L;i++){
    const j = randInt(i+1);
    if(j<target) out[j] = freeList[i];
  }
  return out;
}
function persistDaily(){ const key='daily_'+todayKey(); try{ localStorage.setItem(key, JSON.stringify(DAILY||[])) }catch(_){ } }
function loadDailyFromCache(){
  const key='daily_'+todayKey();
  try{
    const cached = JSON.parse(localStorage.getItem(key)||'[]');
    if(Array.isArray(cached)&&cached.length){
      DAILY = cached.filter(n => ALL[n]==='libre');
      persistDaily();
      return DAILY.length>0;
    }
  }catch(_){}
  return false;
}
function pickDaily(force=false){
  if(!force && loadDailyFromCache()) return;
  const libres = Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
  DAILY = sampleDailyFromFreeList(libres, 240);
  persistDaily();
}

async function syncMapFast(){
  try{
    const txt = await fetchCsvAny(GID_RAFFLES, 9000);
    const rows = parseCSV(txt);
    if(rows.length < 2) return;
    const freeList=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]||[];
      const a=(r[0]??'').toString().trim();
      const b=(r[1]??'').toString().trim();
      if(!a) continue;
      let digits=a.replace(/\D/g,''); if(!digits) continue;
      if(digits.length>4) digits=digits.slice(0,4);
      const num=digits.padStart(4,'0');
      if (normStatusAB(b)==='libre') freeList.push(num);
    }
    saveMapCache(freeList);
    setAllFromFreeList(freeList);

    const before=DAILY.length;
    DAILY = DAILY.filter(n=>ALL[n]==='libre');
    if(DAILY.length===0) pickDaily(true);
    if(DAILY.length!==before) renderGrid();
  }catch(_){}
}

/* =========================
   B√∫squeda
   ========================= */
async function rerenderSearch(){
  hideMsg();
  const raw=(SEARCH_INPUT.value||'').replace(/\D/g,'').slice(0,4);
  if(SEARCH_INPUT.value!==raw) SEARCH_INPUT.value=raw;

  if(raw.length===0){
    document.body.classList.remove('search-has-text');
    clearSearchLayer();
    return;
  }

  document.body.classList.add('search-has-text');
  const padded=pad4(raw);
  const st=ALL[padded]||'ocupado';
  if(st==='libre'){ renderSearchOne(padded); }
  else{ clearSearchLayer(); msg('Boleta ocupada', true); }
}

/* =========================
   INIT
   ========================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  initBootBubbles();
  bootShow('Cargando‚Ä¶', 'Verificando acceso');

  // Botones bloqueado
  const br = document.getElementById('blockedReload');
  const bw = document.getElementById('blockedWhats');
  if(br) br.addEventListener('click', ()=> location.reload());
  if(bw) bw.addEventListener('click', ()=> openWAContact());

  // Viewport / header height
  function applyViewportOffset(){
    let top=0;
    if(window.visualViewport){ top=Math.max(0,Math.round(window.visualViewport.offsetTop||0)); }
    document.documentElement.style.setProperty('--vv-top', top + 'px');
    recalcHeaderHeightDynamic();
  }
  recalcHeaderHeightDynamic();
  applyViewportOffset();
  if(window.visualViewport){
    visualViewport.addEventListener('resize',()=>requestAnimationFrame(applyViewportOffset));
    visualViewport.addEventListener('scroll',()=>requestAnimationFrame(applyViewportOffset));
  }
  window.addEventListener('resize',()=>requestAnimationFrame(applyViewportOffset),{passive:true});

  // 1) Config + acceso (fail-closed)
  bootShow('Cargando‚Ä¶', 'Leyendo Configuraci√≥n');
  const access = await loadConfigAndCheckAccess();

  // Carga logo en paralelo (no bloqueante)
  bootShow('Cargando‚Ä¶', 'Cargando logo');
  loadLogoFromNotificaciones().catch(()=>{});

  if(access.blocked){
    const isRealBlock = access.ok; // pudo leer X2=TRUE
    const text = isRealBlock
      ? 'Acceso restringido desde Configuracion.\n\nPara habilitar: pon Configuracion!X2 = FALSE.'
      : 'No se pudo verificar Configuracion por error de red/proxy.\n\nPor seguridad el acceso queda restringido. Pulsa ‚ÄúReintentar‚Äù.';

    const hint = isRealBlock
      ? 'Tip: Si ya pusiste X2=FALSE y sigue bloqueado, revisa que est√©s editando la hoja correcta (gid Configuracion) y que el proxy est√© respondiendo CSV.'
      : ('Detalle t√©cnico (√∫til para diagn√≥stico):\n' +
         (access.reason ? `- ${access.reason}\n` : '') +
         (access.details ? `\nRespuesta/fragmento:\n${access.details}` : ''));

    blockedShow({
      title: 'P√°gina temporalmente inhabilitada',
      text,
      hint
    });
    return;
  }

  // Inputs
  SEARCH_INPUT=document.getElementById('search');

  function instantFocus(e){
    if(document.activeElement!==SEARCH_INPUT){
      e.preventDefault();
      SEARCH_INPUT.focus({preventScroll:true});
      setTimeout(()=>{ try{ const len=SEARCH_INPUT.value.length; SEARCH_INPUT.setSelectionRange(len,len);}catch(_){ }},0);
    }
  }
  SEARCH_INPUT.addEventListener('pointerdown',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('touchstart',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('click',()=>{ if(document.activeElement!==SEARCH_INPUT) SEARCH_INPUT.focus({preventScroll:true}); },{passive:true});
  SEARCH_INPUT.addEventListener('input',()=>{ rerenderSearch(); });
  SEARCH_INPUT.addEventListener('blur',()=>{ if(!MODAL_OPEN && SEARCH_INPUT.value.trim().length===0){ document.body.classList.remove('search-has-text'); clearSearchLayer(); } });

  // Bot√≥n ALEATORIO
  const randomBtn=document.getElementById('randomButton');
  randomBtn.addEventListener('click', async ()=>{
    if(randomBtn.dataset.busy==='1') return;
    randomBtn.dataset.busy='1';
    hideMsg();

    clearSearchLayer();
    document.body.classList.add('search-has-text');

    if(!ALL || !Object.keys(ALL).length){
      const c=loadMapCache();
      if(c?.freeList) setAllFromFreeList(c.freeList);
      else await syncMapFast();
    }

    const libres=Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
    const chosen = libres.length ? libres[randInt(libres.length)] : String(randInt(10000)).padStart(4,'0');

    SEARCH_INPUT.value=String(parseInt(chosen,10));
    const st=ALL[chosen]||'ocupado';
    if(st==='libre'){ renderSearchOne(chosen); }
    else{ clearSearchLayer(); msg('Boleta ocupada', true); }

    randomBtn.dataset.busy='';
  },{passive:true});

  // Bot√≥n FINALIZAR
  const finishTopBtn = document.getElementById('finishTop');
  if(finishTopBtn){
    finishTopBtn.addEventListener('click',(e)=>{
      e.preventDefault();
      finalizeCart();
    });
  }

  // 2) Arranque del mapa
  bootShow('Cargando‚Ä¶', 'Preparando boletas');
  DAY_MARK=todayKey();

  const mcache=loadMapCache();
  if(mcache?.freeList){
    setAllFromFreeList(mcache.freeList);
    pickDaily(true);
    renderGrid();

    // refresco suave si cache viejo
    if(mcache.stale){
      (window.requestIdleCallback ? requestIdleCallback(syncMapFast) : setTimeout(syncMapFast,0));
    }else{
      setTimeout(syncMapFast, 1200);
    }
  }else{
    // skeleton r√°pido
    const wrap=document.getElementById('raffles');
    const frag=document.createDocumentFragment();
    for(let i=0;i<24;i++){
      const s=document.createElement('div');
      s.className='raffle';
      s.innerHTML='<span>----</span>';
      frag.appendChild(s);
    }
    wrap.appendChild(frag);

    await syncMapFast();
    pickDaily(true);
    renderGrid();
  }

  bootHide();

  // refrescos
  GRID_TIMER=setInterval(()=>renderGrid(), 20000);
  MAP_TIMER=setInterval(async ()=>{
    const nowKey=todayKey();
    if(nowKey!==DAY_MARK){
      DAY_MARK=nowKey;
      await syncMapFast();
      DAILY=[];
      pickDaily(true);
      renderGrid();
      return;
    }
    const before=DAILY.length;
    await syncMapFast();
    if(DAILY.length!==before) renderGrid();
  }, 20000);
});
  </script>
</body>
</html>
